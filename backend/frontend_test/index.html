<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Razorpay Test — Dummy Frontend</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 24px; max-width: 900px; margin: auto; }
    h1 { font-size: 20px; margin-bottom: 8px; }
    label { display:block; margin-top: 12px; font-weight:600; }
    input, button, textarea { padding: 10px; font-size:14px; width:100%; box-sizing:border-box; margin-top:6px; }
    .row { display:flex; gap:12px; }
    .col { flex:1; }
    button { cursor:pointer; }
    pre { background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto; }
    .small { font-size:13px; color:#666; margin-top:6px; }
  </style>
</head>
<body>

  <h1>Razorpay Test — Dummy Frontend</h1>
  <p class="small">
    Enter an existing local <strong>order_id</strong> and your <strong>Bearer auth token</strong>.
    The page will call <code>POST /payments/create-session</code> on your backend (default <code>http://localhost:8000</code>).
  </p>

  <label>Backend base URL</label>
  <input id="backendUrl" placeholder="http://localhost:8000" value="http://localhost:8000" />

  <label>Bearer Token (Authorization)</label>
  <input id="token" placeholder="Bearer token (copy from login)" />

  <div class="row">
    <div class="col">
      <label>Order ID (local order id)</label>
      <input id="orderId" placeholder="e.g. 1" />
    </div>
    <div style="width:140px">
      <label>&nbsp;</label>
      <button id="createSessionBtn">Create session</button>
    </div>
  </div>

  <div style="margin-top:14px">
    <label>Session Info / Logs</label>
    <pre id="log">No actions yet.</pre>
  </div>

  <div style="margin-top:12px">
    <button id="payBtn" disabled>Pay (open Razorpay)</button>
    <div class="small">If button is disabled, create a session first.</div>
  </div>

  <div style="margin-top:16px">
    <label>Verify Response</label>
    <pre id="verifyResult">--</pre>
  </div>

  <!-- Razorpay checkout script -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <script>
    const createBtn = document.getElementById('createSessionBtn');
    const payBtn = document.getElementById('payBtn');
    const logEl = document.getElementById('log');
    const verifyEl = document.getElementById('verifyResult');

    let session = null; // will store backend response for session

    function log(msg) {
      const t = new Date().toLocaleTimeString();
      logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent;
    }

    async function createSession() {
      const base = document.getElementById('backendUrl').value.trim() || 'http://localhost:8000';
      const token = document.getElementById('token').value.trim();
      const orderId = document.getElementById('orderId').value.trim();
      if (!orderId) { alert('Enter order id'); return; }
      log('Creating payment session for order ' + orderId + ' ...');

      try {
        const res = await fetch(`${base}/payments/create-session`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
          },
          body: JSON.stringify({ order_id: Number(orderId) })
        });

        const data = await res.json();

        if (!res.ok) {
          log('Create-session failed: ' + (data.detail || JSON.stringify(data)));
          session = null;
          payBtn.disabled = true;
          return;
        }

        // expected fields: razorpay_order_id, amount (paise), currency, key_id, order_id
        session = data.data;
        log('Session created: ' + JSON.stringify(data));
        payBtn.disabled = false;

      } catch (err) {
        log('Network/create-session error: ' + err.message);
      }
    }

    createBtn.addEventListener('click', createSession);

    payBtn.addEventListener('click', async () => {
      if (!session) { alert('Create a session first'); return; }

      /* Build options for Razorpay checkout using backend response.
         Razorpay expects amount in paise, order_id (razorpay_order_id), and the key. */
      const options = {
        key: session.key_id, // received from backend
        amount: session.amount, // in paise
        currency: session.currency || 'INR',
        name: "Test Store",
        description: `Payment for local order ${session.order_id}`,
        order_id: session.razorpay_order_id,
        handler: async function (response) {
          // response contains: razorpay_order_id, razorpay_payment_id, razorpay_signature
          log('Razorpay success callback: ' + JSON.stringify(response));

          // send verification to your backend
          response.razorpay_signature = "INVALID_SIGNATURE";
          await verifyPaymentWithBackend(response);

        },
        prefill: {
          name: "Test User",
          email: "test@example.com",
          contact: "9999999999"
        },
        notes: {
          local_order_id: String(session.order_id)
        },
        theme: { color: "#1976D2" }
      };

      const rzp = new Razorpay(options);

      rzp.on('payment.failed', function (resp) {
        log('Payment failed: ' + JSON.stringify(resp.error));
      });

      rzp.open();
    });

    async function verifyPaymentWithBackend(rpResponse) {
      const base = document.getElementById('backendUrl').value.trim() || 'http://localhost:8000';
      const token = document.getElementById('token').value.trim();
      const payload = {
        order_id: Number(document.getElementById('orderId').value),
        razorpay_order_id: rpResponse.razorpay_order_id,
        razorpay_payment_id: rpResponse.razorpay_payment_id,
        razorpay_signature: rpResponse.razorpay_signature
      };

      log('Sending verify request to backend...');
      try {
        const res = await fetch(`${base}/payments/verify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) {
          log('Verify failed: ' + (data.detail || JSON.stringify(data)));
          verifyEl.textContent = JSON.stringify(data, null, 2);
          return;
        }

        log('Verify succeeded: ' + JSON.stringify(data));
        verifyEl.textContent = JSON.stringify(data, null, 2);

      } catch (err) {
        log('Network/verify error: ' + err.message);
        verifyEl.textContent = err.message;
      }
    }

    // small helper: show CORS hint
    (function(){
      log('Dummy frontend loaded. Remember to enable CORS on your FastAPI backend for this origin.');
    })();
  </script>
</body>
</html>
